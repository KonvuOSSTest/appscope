version: '3.5'

x-scope-common: &scope-common
  volumes:
    - ./logs:/opt/test-runner/logs:rw
    - ../..:/opt/appscope
  working_dir: /opt/appscope
  privileged: true

x-java-common: &java-common
  environment:
    - LD_PRELOAD=/usr/local/scope/lib/libscope.so
  <<: *scope-common

services:

  # These tests run on all platforms; x86_64 and aarch64

  syscalls:
    image: scopeci/scope-syscalls-it
    build:
      cache_from:
        - scopeci/scope-syscalls-it
      context: .
      dockerfile: ./syscalls/Dockerfile
    <<: *scope-common

  logstream:
    image: scopeci/scope-logstream-it
    build:
      cache_from: 
        - scopeci/scope-logstream-it
      context: .
      dockerfile: ./logstream/Dockerfile
    ports:
      - 9000:9000
    <<: *scope-common

  nginx:
    image: scopeci/scope-nginx-it
    build:
      cache_from:
        - scopeci/scope-nginx-it
      context: .
      dockerfile: ./nginx/Dockerfile
    <<: *scope-common

  elastic:
    image: scopeci/scope-elastic-it
    build:
      cache_from:
        - scopeci/scope-elastic-it
      context: .
      dockerfile: ./elastic/Dockerfile
    <<: *scope-common

  kafka:
    image: scopeci/scope-kafka-it
    build:
      cache_from:
        - scopeci/scope-kafka-it
      context: .
      dockerfile: ./kafka/Dockerfile
    ports:
      - 9092:9092
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: 'zookeeper:2181'
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://broker:29092,PLAINTEXT_HOST://localhost:9092
      KAFKA_METRIC_REPORTERS: io.confluent.metrics.reporter.ConfluentMetricsReporter
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: 0
      CONFLUENT_METRICS_REPORTER_BOOTSTRAP_SERVERS: broker:29092
      CONFLUENT_METRICS_REPORTER_ZOOKEEPER_CONNECT: zookeeper:2181
      CONFLUENT_METRICS_REPORTER_TOPIC_REPLICAS: 1
      CONFLUENT_METRICS_ENABLE: 'true'
      CONFLUENT_SUPPORT_CUSTOMER_ID: 'anonymous'
    <<: *scope-common

  tls:
    image: scopeci/scope-tls-it
    build:
      cache_from: 
        - scopeci/scope-tls-it
      context: .
      dockerfile: ./tls/Dockerfile
    <<: *scope-common

  detect_proto:
    image: scopeci/scope-detect_proto-it
    build:
      cache_from: 
        - scopeci/scope-detect_proto-it
      context: .
      dockerfile: ./detect_proto/Dockerfile
    ports:
      - 6379:6379
      - 27017:27017
    <<: *scope-common

  java8:
    image: scopeci/scope-java8-it
    build:
      cache_from: 
        - scopeci/scope-java8-it
      context: .
      dockerfile: ./java/Dockerfile
      args:
        JDK_IMAGE: openjdk:8
        DNLD_HEXDUMP: apt-get -o Acquire::Check-Valid-Until=false update && apt-get install -y bsdmainutils
    <<: *java-common
  java9:
    image: scopeci/scope-java9-it
    build:
      cache_from: 
        - scopeci/scope-java9-it
      context: .
      dockerfile: ./java/Dockerfile
      args:
        JDK_IMAGE: openjdk:9
        DNLD_HEXDUMP: apt-get -o Acquire::Check-Valid-Until=false update && apt-get install -y bsdmainutils
    <<: *java-common
  java10:
    image: scopeci/scope-java10-it
    build:
      cache_from: 
        - scopeci/scope-java10-it
      context: .
      dockerfile: ./java/Dockerfile
      args:
        JDK_IMAGE: openjdk:10
        DNLD_HEXDUMP: apt-get -o Acquire::Check-Valid-Until=false update && apt-get install -y bsdmainutils
    <<: *java-common
  java11:
    image: scopeci/scope-java11-it
    build:
      cache_from: 
        - scopeci/scope-java11-it
      context: .
      dockerfile: ./java/Dockerfile
      args:
        JDK_IMAGE: openjdk:11
        DNLD_HEXDUMP: apt-get -o Acquire::Check-Valid-Until=false update && apt-get install -y bsdmainutils
    <<: *java-common
  java12:
    image: scopeci/scope-java12-it
    build:
      cache_from: 
        - scopeci/scope-java12-it
      context: .
      dockerfile: ./java/Dockerfile
      args:
        JDK_IMAGE: openjdk:12
        DNLD_HEXDUMP: yum -y install util-linux
    <<: *java-common
  java13:
    image: scopeci/scope-java13-it
    build:
      cache_from: 
        - scopeci/scope-java13-it
      context: .
      dockerfile: ./java/Dockerfile
      args:
        JDK_IMAGE: openjdk:13
        DNLD_HEXDUMP: yum -y install util-linux
    <<: *java-common
  java14:
    image: scopeci/scope-java14-it
    build:
      cache_from: 
        - scopeci/scope-java14-it
      context: .
      dockerfile: ./java/Dockerfile
      args:
        JDK_IMAGE: openjdk:14
        DNLD_HEXDUMP: microdnf install util-linux
    <<: *java-common

  alpine:
    image: scopeci/scope-alpine-it
    build:
      cache_from:
        - scopeci/scope-alpine-it
      context: .
      dockerfile: ./alpine/Dockerfile
    <<: *scope-common

  transport:
    image: scopeci/scope-transport-it
    build:
      cache_from:
        - scopeci/scope-transport-it
      context: .
      dockerfile: ./transport/Dockerfile
    ports:
      - "9000:9000"
    <<: *scope-common

# vim: ts=2 sw=2 et :
